#!/bin/bash

set -x
set -e

repo=renciorg

function get_ver () {
    if [ ! -f "bin/.ver" ]
    then
        echo "The version file .ver does not exist."
        echo "Please check for or re-create bin/.ver"
        return 255
    fi

    ver=$(< bin/.ver)
    echo "$ver"
    return 0
}
prep () {
    export APP=$PWD
    pushd $1
    $APP/bin/spark build-spark
    popd
    pushd spark
    $APP/bin/spark build-spark
#    $APP/blackbalsam-jupyter/libspark get_spark clean
#    $APP/bin/spark configure_alluxio
    popd
}
#export SPARK_DIST_CLASSPATH_ARG='/usr/local/hadoop/etc/hadoop:/usr/local/hadoop/share/hadoop/common/lib/*:/usr/local/hadoop/share/hadoop/common/*:/usr/local/hadoop/share/hadoop/hdfs:/usr/local/hadoop/share/hadoop/hdfs/lib/*:/usr/local/hadoop/share/hadoop/hdfs/*:/usr/local/hadoop/share/hadoop/mapreduce/lib/*:/usr/local/hadoop/share/hadoop/mapreduce/*:/usr/local/hadoop/share/hadoop/yarn:/usr/local/hadoop/share/hadoop/yarn/lib/*:/usr/local/hadoop/share/hadoop/yarn/*'
build () {
    local mod=$1
    if [ -z "$mod" ]; then
        echo module name required
    fi
    newversion=$(get_ver)
    rc=$?
    if [ $rc -eq 255 ]
    then
        echo "Version file .ver not found."
        echo "Please check for or re-create bin/.ver"
    fi
    prep $mod
    docker build --no-cache $mod \
           --build-arg SPARK_DIST_CLASSPATH_ARG=$SPARK_DIST_CLASSPATH_ARG \
	   --file $mod/Dockerfile \
	   -t $repo/$mod:latest \
	   -t $repo/$mod:$newversion
}
push () {
    local mod=$1
    if [ -z "$mod" ]; then
        echo module name required
    fi
    vers=$(get_ver)
    rc=$?
    if [ $rc -eq 255 ]
    then
        echo "Version file .ver not found."
        echo "Please check for or re-create bin/.ver"
    fi
    docker push $repo/$mod:latest
    docker push $repo/$mod:$vers
}
build-push () {
    build $1
    push $1
}
clean () {
    images () {
        pat=$1
        if [ -z "$pat" ]; then
            pat=$repo
        fi
        echo $pat
        for i in $(sudo docker images | grep $pat | awk '{ print $3 }' | grep -vi image ); do echo $i; sudo docker rmi -f $i; done
    }
    $*
}
all () {
    for mod in $(ls -d */ | grep -v bin | sed s,/,,g); do
        build $mod
        push $mod
    done
}
kill () {
    local mod=$1
    if [ -z "$mod" ]; then
        echo module name required
    fi
    docker kill -s 9 $mod
}
shell () {
        local mod=$1
    if [ -z "$mod" ]; then
        echo module name required
    fi
    docker exec -it $mod bash
}

$*
